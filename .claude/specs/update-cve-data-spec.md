# UpdateCveData Command Specification

## Overview
Artisan command to fetch and update CVE (Common Vulnerabilities and Exposures) data for network ports, enriching the `port_security` table with vulnerability counts and latest CVE information.

## API Options Comparison

### Option 1: NVD (NIST National Vulnerability Database) ⭐ RECOMMENDED
**Endpoint:** `https://services.nvd.nist.gov/rest/json/cves/2.0`

**Pros:**
- Most authoritative source (NIST-operated)
- 314,931+ CVE records
- Rich vulnerability scoring (CVSS)
- Free with optional API key
- Incremental updates via date filtering

**Cons:**
- Rate limits: 5 req/30s (no key) or 50 req/30s (with key)
- Max 120-day date range per query
- Recent reliability issues reported
- Slower updates (NVD enriches CVE data after initial publication)

**Authentication:**
- Optional API key (get at https://nvd.nist.gov/developers/request-an-api-key)
- No key required, but rate limits are much stricter
- Key passed in header: `apiKey: {value}`

**Rate Limits:**
- Without key: 5 requests per 30 seconds
- With key: 50 requests per 30 seconds
- Recommended: Wait 2+ hours between full updates

### Option 2: Shodan CVEDB 🚀 ALTERNATIVE
**Endpoint:** `https://cvedb.shodan.io`

**Pros:**
- Free for non-commercial use
- No authentication required for basic use
- Daily updates
- Fast responses
- Enhanced search (KEV, EPSS scores)
- Simpler API

**Cons:**
- Commercial use requires enterprise license
- Less detailed than NVD for some fields
- Relies on NVD as upstream source

**Authentication:**
- None required for non-commercial use
- Enterprise license for commercial use

**Key Features:**
- Search by CPE, product name, date range
- Filter by KEV (Known Exploited Vulnerabilities)
- Sort by EPSS (Exploit Prediction Scoring)

### Option 3: CIRCL Vulnerability-Lookup
**Pros:**
- Aggregates multiple sources (NVD, CERT-Bund, CISA, Cisco, Red Hat, etc.)
- Public API available
- OpenAPI documented

**Cons:**
- Less documentation available
- Additional complexity with multi-source data

## Recommended Approach for Commercial Use

**Primary: NVD API (REQUIRED)** - Free with API key, suitable for commercial use
**Note:** Shodan CVEDB requires enterprise license for commercial projects, so NOT viable for techreference.io

## Data Mapping Strategy

### Port → CVE Lookup Methods

1. **By Service Name** (e.g., "MySQL", "Apache", "nginx")
   - Search CVEs by product name or keywords
   - Match against `ports.service_name` field

2. **By Software** (via port_software relationship)
   - Query CVEs for specific software/versions
   - Use CPE (Common Platform Enumeration) if available
   - Example: `cpe:2.3:a:mysql:mysql:*:*:*:*:*:*:*:*`

3. **By Protocol/Port Number**
   - Some CVEs reference port numbers in descriptions
   - Keyword search: "port 3306", "TCP 443", etc.

### CVE Fields to Extract

**For NVD API Response:**
```json
{
  "cve": {
    "id": "CVE-2024-12345",
    "published": "2024-01-15T10:00:00",
    "lastModified": "2024-02-01T14:30:00",
    "descriptions": [
      {
        "lang": "en",
        "value": "Description of vulnerability..."
      }
    ],
    "metrics": {
      "cvssMetricV31": [
        {
          "cvssData": {
            "baseScore": 9.8,
            "baseSeverity": "CRITICAL"
          }
        }
      ]
    },
    "configurations": [
      {
        "nodes": [
          {
            "cpeMatch": [
              {
                "vulnerable": true,
                "criteria": "cpe:2.3:a:vendor:product:version..."
              }
            ]
          }
        ]
      }
    ]
  }
}
```

### Database Fields to Update (port_security table)

| Field | Type | Source | Notes |
|-------|------|--------|-------|
| `cve_count` | unsignedInteger | Count of CVEs | Total vulnerabilities for this port's services |
| `latest_cve` | string(50) | Most recent CVE ID | e.g., "CVE-2024-12345" |
| `cve_updated_at` | timestamp | Current time | Last update timestamp |

**Potential Enhancement:** Consider adding JSON field for detailed CVE data
```php
$table->json('cve_details')->nullable(); // Array of recent CVEs with scores
```

## Implementation Requirements

### 1. Environment Configuration (.env)
```bash
# NVD API (API key optional - get free key at https://nvd.nist.gov/developers/request-an-api-key)
NVD_API_KEY=  # Leave empty if no key yet
NVD_API_ENDPOINT=https://services.nvd.nist.gov/rest/json/cves/2.0

# Rate limiting
# Without API key: 5 requests per 30 seconds (6 second delay required)
# With API key: 50 requests per 30 seconds (0.6 second delay)
CVE_UPDATE_DELAY_SECONDS=6  # 6 seconds for public API, 1 for API key
CVE_BATCH_SIZE=5            # Small batches for public API rate limits
```

### 2. Command Implementation Path
**File:** `app/Console/Commands/Ports/UpdateCveData.php`

**Signature:** `php artisan ports:update-cve`

**Options:**
- `--port={number}` - Update specific port
- `--service={name}` - Update all ports for specific service
- `--force` - Ignore last update timestamp

### 3. Algorithm Flow

```
1. Query ports with associated software/service names
   - Join with software table to get software names
   - OR use ports.service_name field

2. For each port/service:
   a. Construct search query (service name, software names)
   b. Call CVE API with appropriate filters
   c. Parse response and count CVEs
   d. Identify latest CVE by date
   e. Update port_security table
   f. Sleep 6 seconds to respect rate limits (5 req/30s = 1 req every 6s)

3. Handle errors gracefully:
   - API failures → log and continue
   - Rate limit exceeded → exponential backoff
   - No results → set cve_count = 0, latest_cve = null

4. Progress reporting:
   - Console progress bar
   - Summary statistics at end
```

### 4. Query Strategy (NVD API)

**Search by keyword (no API key):**
```
GET /rest/json/cves/2.0?keywordSearch=mysql&resultsPerPage=100
(No auth header needed for public API)
```

**Search by keyword (with API key):**
```
GET /rest/json/cves/2.0?keywordSearch=mysql&resultsPerPage=100
Header: apiKey: {your-api-key}
```

**Search by CPE:**
```
GET /rest/json/cves/2.0?cpeName=cpe:2.3:a:mysql:mysql
```

**Incremental update (only modified since last check):**
```
GET /rest/json/cves/2.0?lastModStartDate=2024-01-01T00:00:00.000&lastModEndDate=2024-01-15T23:59:59.999
```

**Pagination:**
```
GET /rest/json/cves/2.0?keywordSearch=apache&resultsPerPage=100&startIndex=100
```

**Implementation Note:** Command should auto-detect if API key is set and adjust delay accordingly:
- If `NVD_API_KEY` is empty/null → use 6 second delay (public rate limit)
- If `NVD_API_KEY` is set → use 1 second delay (authenticated rate limit)

### 5. Data Validation Rules

- Only count CVEs with CVSS score > 0 (excludes rejected/disputed)
- Exclude CVEs marked as "REJECT" or "DISPUTED"
- Note: NVD API has 120-day max range limit, so queries fetch all CVEs without date filters

### 6. Caching Strategy

- Cache CVE counts per service name (1 hour TTL)
- Prevents duplicate API calls for same service
- Key: `cve:service:{service_name}`

```php
Cache::remember("cve:service:mysql", 3600, function() {
    return $this->fetchCveData('mysql');
});
```

### 7. Testing Requirements

**Unit Tests:**
- Mock API responses
- Test rate limiting
- Test error handling
- Test data parsing

**Feature Tests:**
- Test command execution
- Verify database updates
- Test --port and --service options

**Sample Test CVE Data:**
```php
// MySQL CVE example
'CVE-2024-20994' // MySQL vulnerability
'CVE-2023-21980' // Another MySQL CVE

// Apache CVE example
'CVE-2024-24795' // Apache HTTP Server
```

## API Response Examples

### NVD API Sample Response
```json
{
  "resultsPerPage": 100,
  "startIndex": 0,
  "totalResults": 234,
  "vulnerabilities": [
    {
      "cve": {
        "id": "CVE-2024-20994",
        "published": "2024-01-16T22:15:00.000",
        "lastModified": "2024-01-25T18:15:00.000",
        "descriptions": [
          {
            "lang": "en",
            "value": "Vulnerability in Oracle MySQL Server..."
          }
        ],
        "metrics": {
          "cvssMetricV31": [
            {
              "cvssData": {
                "baseScore": 4.9,
                "baseSeverity": "MEDIUM"
              }
            }
          ]
        }
      }
    }
  ]
}
```


## Success Metrics

**Without API key (5 req/30s):**
- CVE data updated for 100 unique services in ~10 minutes (100 services × 6s = 600s)
- 1,000 ports (many share same service) in ~20 minutes
- < 1% API error rate
- Accurate CVE counts (verified against manual checks)
- Latest CVE correctly identified by date

**With API key (50 req/30s):**
- CVE data updated for 1,000+ ports in < 3 minutes
- Significantly faster processing for large batches

## Future Enhancements

1. **Detailed CVE Storage** - Add `cve_details` JSON column with top 10 CVEs
2. **Severity Breakdown** - Count by CVSS score (critical/high/medium/low)
3. **KEV Tracking** - Flag ports with Known Exploited Vulnerabilities
4. **EPSS Integration** - Store exploit prediction scores
5. **Historical Tracking** - Track CVE count changes over time
6. **Alerts** - Notify when new critical CVEs discovered for monitored ports

## References

- NVD API Docs: https://nvd.nist.gov/developers/vulnerabilities
- Request API Key: https://nvd.nist.gov/developers/request-an-api-key
- CPE Specification: https://nvd.nist.gov/products/cpe
- CVSS Scoring: https://www.first.org/cvss/
